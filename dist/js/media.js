"use strict";function showMedia(e,t){e.forEach(function(i,a){a%4===0&&($("#media").append('<div id="row'+rowsProcessed+'" class="row"></div>'),rowsProcessed+=1);var o=(getCookie("server")+"/media/file/"+i.id,""),l="";"experience"===i.association_type&&(o='<br><a href="/experience.html?'+i.association+'">View Experience ('+i.exp_title+")</a>",l='<a class="page-action" style="font-size: 18px;" onclick="editMedia('+i.id+');"><i class="material-icons" style="position: relative; top: 6px;">reorder</i></a>');var r="";i.explicit&&(r='style="-webkit-filter: blur(15px); filter: blur(15px);"');var d="";i.favorite&&(d='<i class="material-icons" style="color: gold;">thumb_up</i>');var n="<br>[no tags]";i.tags&&(n="<br>"+i.tags),$("#row"+(rowsProcessed-1)).append('<div class="col s12 m3"><div class="card"><div class="card-image"><a id="imagelink'+i.id+'" target="_blank"><img id="image'+i.id+'" '+r+'><span class="card-title" id="title-'+i.id+'" style="background-color: rgba(0, 0, 0, 0.5);">'+d+i.title+'</span><a/></div><div class="card-content"><p>'+l+new Date(1e3*i.date).toISOString().slice(5,16).replace(/T/," ").replace("-","/")+'<span id="tags-'+i.id+'">'+n+"</span>"+o+"</p></div></div></div>"),makeAuthBlobRequest("/media/file/"+i.id,function(e){var t=new FileReader;t.onload=function(e){var t,a;e.target.result.indexOf("/9j/")>-1?(a="image/png",t=e.target.result.replace("application/octet-stream","image/png")):e.target.result.indexOf("iVBOR")>-1?(a="image/png",t=e.target.result.replace("application/octet-stream","image/png")):e.target.result.indexOf("R0lGO")>-1?(a="image/gif",t=e.target.result.replace("application/octet-stream","image/gif")):e.target.result.indexOf("HGZ0eX")>-1?(a="video/mp4",t=e.target.result.replace("application/octet-stream","video/mp4"),$("#image"+i.id).replaceWith('<video autoplay loop style="width: 100%;"><source id="image'+i.id+'" type="video/mp4"></video>')):(a="image/png[unknown]",t=e.target.result.replace("application/octet-stream","image/png")),$("#image"+i.id).attr("src",t),$("#imagelink"+i.id).attr("href",t),$("#imagelink"+i.id).attr("x-mime",a)},t.readAsDataURL(e)}),a===e.length-1&&(imagesPopulated=!0,"function"==typeof t&&t())})}function loadMore(){atEnd||makeAuthRequest("/media/search","POST",JSON.stringify({limit:batchSize,offset:currentBatch*batchSize}),"json",function(e,t,i){404!==i&&t.length===batchSize?currentBatch+=1:atEnd=!0,showMedia(t,function(){$("#loading").hide(),$("#media").show()})})}function prepareAdd(){var e=new Date,t=e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+" "+("0"+e.getHours()).slice(-2)+("0"+e.getMinutes()).slice(-2);$("#customTime").val(t),makeAuthRequest("/experience/search","POST",null,"json",function(e,t,i){return t.length<1?($("#experience").append('<option value="" disabled selected>None</option>'),void $("#editExperience").append('<option value="" disabled selected>None</option>')):(t.sort(function(e,t){return parseFloat(t.date)-parseFloat(e.date)}),void t.forEach(function(e){$("#experience").append('<option value="'+e.id+'">'+new Date(1e3*e.date).toISOString().slice(0,10)+" -- "+e.title+"</option>"),$("#editExperience").append('<option value="'+e.id+'">'+new Date(1e3*e.date).toISOString().slice(0,10)+" -- "+e.title+"</option>")}))})}function prepareFilter(){var e=new Date,t=e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+" "+("0"+e.getHours()).slice(-2)+("0"+e.getMinutes()).slice(-2);$("#filterEndDate").val(t),$("#filterStartDate").val("1975-01-01 0000")}function deleteMedia(){var e=$("#editID").val();makeAuthRequest("/media","DELETE",JSON.stringify({id:e}),"json",function(t,i,a){return 200!==a?($("#editMediaModal").closeModal(),void Materialize.toast("Deletion error: "+t,6e3,"warning-toast")):($("#editMediaModal").closeModal(),Materialize.toast("Media deleted",6e3,"success-toast"),void $("#cardid-"+e).hide())})}function editMedia(e){event.preventDefault(),event.stopPropagation(),document.activeElement.blur(),makeAuthRequest("/media/"+e,"GET",null,"json",function(t,i,a){$("#editID").val(e),$("#assocType").val(i.association_type),$("#editTitle").val(i.title),$("#editTags").val(i.tags),$("#editTime").val(new Date(1e3*i.date).toISOString().slice(0,16).replace(/T/," ").replace(":","")),$("#editTitleLabel, #editTagsLabel, #editTimeLabel").addClass("active"),"drug"===i.association_type?$("#editExperienceRow").hide():$("#editExperience").val(i.association),$("#editExplicit").prop("checked",1===i.explicit),$("#editFavorite").prop("checked",1===i.favorite),$("#editMediaModal").openModal()})}var currentBatch=0,batchSize=20,atEnd=!1,imagesPopulated=!1,rowsProcessed=0;makeAuthRequest("/media/search","POST",null,"json",function(e,t,i){404===i&&($("#loading").hide(),$("#emptyMedia").show())});var autoLoader=function(){$(window).scrollTop()+$(window).height()>$(document).height()-50&&imagesPopulated&&(imagesPopulated=!1,loadMore())};$("#filterForm").submit(function(e){e.preventDefault(),document.activeElement.blur();var t={};$("#filterTitle").val().length>0&&(t.title=$("#filterTitle").val()),$("#filterTags").val().length>0&&(t.tags=$("#filterTags").val()),$("#filterExplicit").is(":checked")!==$("#filterNonExplicit").is(":checked")&&($("#filterExplicit").is(":checked")?t.explicit=1:t.explicit=0),$("#filterFavorite").is(":checked")!==$("#filterNonFavorite").is(":checked")&&($("#filterFavorite").is(":checked")?t.favorite=1:t.favorite=0);var i=$("#filterStartDate").val().split(" ")[0],a=$("#filterStartDate").val().split(" ")[1],o=Math.floor(new Date(i).getTime()/1e3);o+=3600*Math.floor(a/100),o+=60*(a-100*Math.floor(a/100));var l=$("#filterEndDate").val().split(" ")[0],r=$("#filterEndDate").val().split(" ")[1],d=Math.floor(new Date(l).getTime()/1e3);d+=3600*Math.floor(r/100),d+=60*(r-100*Math.floor(r/100)),t.startdate=o,t.enddate=d,makeAuthRequest("/media/search","POST",JSON.stringify(t),"json",function(e,t,i){$(".row").remove(),$(window).off("scroll",autoLoader),showMedia(t,null)})}),$("#editMedia").submit(function(e){e.preventDefault(),document.activeElement.blur();var t=$("#editTime").val().split(" ")[0],i=$("#editTime").val().split(" ")[1],a=Math.floor(new Date(t).getTime()/1e3);a+=3600*Math.floor(i/100),a+=60*(i-100*Math.floor(i/100));var o={id:$("#editID").val(),title:$("#editTitle").val(),tags:$("#editTags").val(),date:a};$("#editFavorite").is(":checked")?o.favorite=1:o.favorite=0,$("#editExplicit").is(":checked")?o.explicit=1:o.explicit=0,"experience"===$("#assocType").val()&&(o.association_type="experience",o.association=$("#editExperience").val()),makeAuthRequest("/media","PUT",JSON.stringify(o),"json",function(e,t,i){return 200!==i?($("#editMediaModal").closeModal(),void Materialize.toast("Update error: "+e,6e3,"warning-toast")):($("#editMediaModal").closeModal(),Materialize.toast("Media updated",6e3,"success-toast"),$("#title-"+$("#editID").val()).html($("#editTitle").val()),void $("#tags-"+$("#editID").val()).html("<br>"+$("#editTags").val()))})}),$("#addMedia").submit(function(e){e.preventDefault(),Materialize.toast("Media uploading",1e5,"success-toast");var t=$("#customTime").val().split(" ")[0],i=$("#customTime").val().split(" ")[1],a=Math.floor(new Date(t).getTime()/1e3);a+=3600*Math.floor(i/100),a+=60*(i-100*Math.floor(i/100));var o=new FormData;o.append("title",$("#title").val()),o.append("tags",$("#tags").val()),"custom"===$("input:radio[name=time]:checked").val()&&o.append("date",a),o.append("association_type","experience"),o.append("association",$("#experience").val()),$("#favorite").is(":checked")&&o.append("favorite",1),$("#explicit").is(":checked")&&o.append("explicit",1),o.append("image",$("#mediaFile").prop("files")[0]);var l=getCookie("auth"),r=getCookie("server"),d=new XMLHttpRequest;d.onload=function(e){4===d.readyState&&(201===d.status?($("#addMediaModal").closeModal(),Materialize.toast("Media added",6e3,"success-toast"),setTimeout(function(){window.location="/media.html"},1e3)):($("#addMediaModal").closeModal(),Materialize.toast(d.statusText,4e3,"warning-toast")))},d.onerror=function(e){$("#addMediaModal").closeModal(),Materialize.toast(d.statusText,4e3,"warning-toast")},d.open("POST",r+"/media"),d.setRequestHeader("Authorization","Basic "+l),d.send(o)}),$("input:radio[name=time]").on("change",function(){"custom"===$("input:radio[name=time]:checked").val()?$("#customTimeArea").show():$("#customTimeArea").hide()}),$(window).scroll(autoLoader),loadMore(),prepareAdd(),prepareFilter();