"use strict";function loadMore(){atEnd||makeAuthRequest("/media/search","POST",JSON.stringify({limit:batchSize,offset:currentBatch*batchSize}),"json",function(e,t,i){404!==i&&t.length===batchSize?currentBatch+=1:atEnd=!0,t.forEach(function(e,i){i%3===0&&($("#media").append('<div id="row'+rowsProcessed+'" class="row"></div>'),rowsProcessed+=1);var a=(getCookie("server")+"/media/file/"+e.id,"");"experience"===e.association_type&&(a='<br><a href="/experience.html?'+e.association+'">View Experience</a>');var o="";e.explicit&&(o='style="-webkit-filter: blur(15px); filter: blur(15px);"');var l="";e.favorite&&(l='<i class="material-icons" style="color: gold;">thumb_up</i>');var r="<br>[no tags]";e.tags&&(r="<br>"+e.tags),$("#row"+(rowsProcessed-1)).append('<div class="col s12 m4"><div class="card" id="cardid-'+e.id+'"><div class="card-image"><a id="imagelink'+e.id+'"><img id="image'+e.id+'" '+o+'><span class="card-title" style="background-color: rgba(0, 0, 0, 0.5);">'+l+e.title+'</span><a/></div><div class="card-content"><p><a class="page-action" style="font-size: 18px;" onclick="editMedia('+e.id+');"><i class="material-icons icon-padding">reorder</i></a>'+new Date(1e3*e.date).toISOString().slice(5,16).replace(/T/," ").replace("-","/")+"<br>"+r+a+"</p></div></div></div>"),makeAuthBlobRequest("/media/file/"+e.id,function(a){$("#image"+e.id).attr("src",URL.createObjectURL(a)),$("#imagelink"+e.id).attr("href",URL.createObjectURL(a)),i===t.length-1&&(imagesPopulated=!0)})}),$("#loading").hide(),$("#media").show()})}function prepareAdd(){var e=new Date,t=e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+" "+("0"+e.getHours()).slice(-2)+("0"+e.getMinutes()).slice(-2);$("#customTime").val(t),makeAuthRequest("/experience/search","POST",null,"json",function(e,t,i){return t.length<1?($("#experience").append('<option value="" disabled selected>None</option>'),void $("#editExperience").append('<option value="" disabled selected>None</option>')):(t.sort(function(e,t){return parseFloat(t.date)-parseFloat(e.date)}),void t.forEach(function(e){$("#experience").append('<option value="'+e.id+'">'+new Date(1e3*e.date).toISOString().slice(0,10)+" -- "+e.title+"</option>"),$("#editExperience").append('<option value="'+e.id+'">'+new Date(1e3*e.date).toISOString().slice(0,10)+" -- "+e.title+"</option>")}))})}function prepareFilter(){var e=new Date,t=e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+" "+("0"+e.getHours()).slice(-2)+("0"+e.getMinutes()).slice(-2);$("#filterEndDate").val(t),$("#filterStartDate").val("1975-01-01 0000")}function deleteMedia(){var e=$("#editID").val();makeAuthRequest("/media","DELETE",JSON.stringify({id:e}),"json",function(t,i,a){return 200!==a?($("#editMediaModal").closeModal(),void Materialize.toast("Deletion error: "+t,6e3,"warning-toast")):($("#editMediaModal").closeModal(),Materialize.toast("Media deleted",6e3,"success-toast"),void $("#cardid-"+e).hide())})}function editMedia(e){event.preventDefault(),event.stopPropagation(),document.activeElement.blur(),makeAuthRequest("/media/"+e,"GET",null,"json",function(t,i,a){$("#editID").val(e),$("#assocType").val(i.association_type),$("#editTitle").val(i.title),$("#editTags").val(i.tags),$("#editTime").val(new Date(1e3*i.date).toISOString().slice(0,16).replace(/T/," ").replace(":","")),$("#editTitleLabel, #editTagsLabel, #editTimeLabel").addClass("active"),"drug"===i.association_type?$("#editExperienceRow").hide():$("#editExperience").val(i.association),$("#editExplicit").prop("checked",1===i.explicit),$("#editFavorite").prop("checked",1===i.favorite),$("#editMediaModal").openModal()})}var currentBatch=0,batchSize=24,atEnd=!1,imagesPopulated=!1,rowsProcessed=0;makeAuthRequest("/media/search","POST",null,"json",function(e,t,i){404===i&&($("#loading").hide(),$("#emptyMedia").show())});var autoLoader=function(){$(window).scrollTop()+$(window).height()>$(document).height()-50&&imagesPopulated&&(imagesPopulated=!1,loadMore())};$("#filterForm").submit(function(e){e.preventDefault(),document.activeElement.blur();var t={};$("#filterTitle").val().length>0&&(t.title=$("#filterTitle").val()),$("#filterTags").val().length>0&&(t.tags=$("#filterTags").val()),$("#filterExplicit").is(":checked")!==$("#filterNonExplicit").is(":checked")&&($("#filterExplicit").is(":checked")?t.explicit=1:t.explicit=0),$("#filterFavorite").is(":checked")!==$("#filterNonFavorite").is(":checked")&&($("#filterFavorite").is(":checked")?t.favorite=1:t.favorite=0);var i=$("#filterStartDate").val().split(" ")[0],a=$("#filterStartDate").val().split(" ")[1],o=Math.floor(new Date(i).getTime()/1e3);o+=3600*Math.floor(a/100),o+=60*(a-100*Math.floor(a/100));var l=$("#filterEndDate").val().split(" ")[0],r=$("#filterEndDate").val().split(" ")[1],d=Math.floor(new Date(l).getTime()/1e3);d+=3600*Math.floor(r/100),d+=60*(r-100*Math.floor(r/100)),t.startdate=o,t.enddate=d,makeAuthRequest("/media/search","POST",JSON.stringify(t),"json",function(e,t,i){$(".row").remove(),$(window).off("scroll",autoLoader),t.forEach(function(e,i){i%3===0&&($("#media").append('<div id="row'+rowsProcessed+'" class="row"></div>'),rowsProcessed+=1);var a=(getCookie("server")+"/media/file/"+e.id,"");"experience"===e.association_type&&(a='<br><a href="/experience.html?'+e.association+'">View Experience</a>');var o="";e.explicit&&(o='style="-webkit-filter: blur(15px); filter: blur(15px);"');var l="";e.favorite&&(l='<i class="material-icons" style="color: gold;">thumb_up</i>');var r="<br>[no tags]";e.tags.length>0&&(r="<br>"+e.tags),$("#row"+(rowsProcessed-1)).append('<div class="col s12 m4"><div class="card"><div class="card-image"><a id="imagelink'+e.id+'"><img id="image'+e.id+'" '+o+'><span class="card-title">'+l+e.title+'</span><a/></div><div class="card-content"><p><a class="page-action" style="font-size: 18px;" onclick="editMedia('+e.id+');"><i class="material-icons" style="position: relative; top: 6px;">reorder</i></a>'+new Date(1e3*e.date).toISOString().slice(5,16).replace(/T/," ").replace("-","/")+"<br>"+r+a+"</p></div></div></div>"),makeAuthBlobRequest("/media/file/"+e.id,function(a){$("#image"+e.id).attr("src",URL.createObjectURL(a)),$("#imagelink"+e.id).attr("href",URL.createObjectURL(a)),i===t.length-1&&(imagesPopulated=!0)})})})}),$("#editMedia").submit(function(e){e.preventDefault(),document.activeElement.blur();var t=$("#editTime").val().split(" ")[0],i=$("#editTime").val().split(" ")[1],a=Math.floor(new Date(t).getTime()/1e3);a+=3600*Math.floor(i/100),a+=60*(i-100*Math.floor(i/100));var o={id:$("#editID").val(),title:$("#editTitle").val(),tags:$("#editTags").val(),date:a};$("#editFavorite").is(":checked")?o.favorite=1:o.favorite=0,$("#editExplicit").is(":checked")?o.explicit=1:o.explicit=0,"experience"===$("#assocType").val()&&(o.association_type="experience",o.association=$("#editExperience").val()),makeAuthRequest("/media","PUT",JSON.stringify(o),"json",function(e,t,i){return 200!==i?($("#editMediaModal").closeModal(),void Materialize.toast("Update error: "+e,6e3,"warning-toast")):($("#editMediaModal").closeModal(),Materialize.toast("Media updated",6e3,"success-toast"),void setTimeout(function(){window.location="/media.html"},1e3))})}),$("#addMedia").submit(function(e){e.efault();var t=$("#customTime").val().split(" ")[0],i=$("#customTime").val().split(" ")[1],a=Math.floor(new Date(t).getTime()/1e3);a+=3600*Math.floor(i/100),a+=60*(i-100*Math.floor(i/100));var o=new FormData;o.append("title",$("#title").val()),o.append("tags",$("#tags").val()),"custom"===$("input:radio[name=time]:checked").val()&&o.append("date",a),o.append("association_type","experience"),o.append("association",$("#experience").val()),$("#favorite").is(":checked")&&o.append("favorite",1),$("#explicit").is(":checked")&&o.append("explicit",1),o.append("image",$("#mediaFile").prop("files")[0]);var l=getCookie("auth"),r=getCookie("server"),d=new XMLHttpRequest;d.onload=function(e){4===d.readyState&&(201===d.status?($("#addMediaModal").closeModal(),Materialize.toast("Media added",6e3,"success-toast"),setTimeout(function(){window.location="/media.html"},1e3)):($("#addMediaModal").closeModal(),Materialize.toast(d.statusText,4e3,"warning-toast")))},d.onerror=function(e){$("#addMediaModal").closeModal(),Materialize.toast(d.statusText,4e3,"warning-toast")},d.open("POST",r+"/media"),d.setRequestHeader("Authorization","Basic "+l),d.send(o)}),$("input:radio[name=time]").on("change",function(){"custom"===$("input:radio[name=time]:checked").val()?$("#customTimeArea").show():$("#customTimeArea").hide()}),$(window).scroll(autoLoader),loadMore(),prepareAdd(),prepareFilter();