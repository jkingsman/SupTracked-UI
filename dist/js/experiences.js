"use strict";function loadMore(){atEnd||makeAuthRequest("/experience/search","POST",JSON.stringify({limit:batchSize,offset:currentBatch*batchSize}),"json",function(e,n,t){404!==t?currentBatch+=1:atEnd=!0,n.sort(function(e,n){return parseFloat(n.date)-parseFloat(e.date)}),n.forEach(function(e){e.title.length<1&&(e.title="[none]");var n={};e.consumptions.forEach(function(e){n.hasOwnProperty(e.drug.name)?n[e.drug.name].count+=e.count:(n[e.drug.name]={},n[e.drug.name].count=e.count,n[e.drug.name].unit=e.drug.unit)});var t=[];if(Object.keys(n).length>0)for(var o in n)t.push(n[o].count+" "+n[o].unit+" "+o);else t.push("no consumptions");var i=[],a="Solo Experience";e.consumptions.forEach(function(e){e.friends.forEach(function(e){-1===i.indexOf(e.name)&&i.push(e.name)})}),i.length>0&&(a=i.join(", "));var r=[],l="[no location]";e.consumptions.forEach(function(e){-1===r.indexOf(e.location)&&r.push(e.location)}),r.length>0&&(l=r.join(", ")),$("#experiences-collection").append('<li class="collection-item">'+new Date(1e3*e.date).toISOString().slice(0,10)+'<span class="right hide-on-med-and-down" style="max-width: 50%;">'+a+" at <strong>"+l+'</strong></span><h5><a href="/experience.html?'+e.id+'">'+e.title+'</a></h5><div class="pad-left-40">'+t.join("<br />")+"</div></li>")}),$("#loading").hide(),$("#experiences").show()})}function prepareFilter(){var e=new Date,n=e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2);$("#filterEndDate").val(n),$("#filterStartDate").val("1975-01-01"),makeAuthRequest("/drug/all","GET",null,"json",function(e,n,t){n.forEach(function(e){$("#drugs").append("<option>"+e.name+"</option>")})}),makeAuthRequest("/method/all","GET",null,"json",function(e,n,t){n.forEach(function(e){$("#methods").append("<option>"+e.name+"</option>")})}),makeAuthRequest("/consumption/friends","GET",null,"json",function(e,n,t){n.forEach(function(e){$("#friends").append("<option>"+e.name+"</option>")})})}var currentBatch=0,batchSize=10,atEnd=!1;makeAuthRequest("/experience/search","POST",JSON.stringify({limit:1}),"json",function(e,n,t){404===t&&($("#loading").hide(),$("#emptyExperiences").show())});var autoLoader=function(){$(window).scrollTop()+$(window).height()>$(document).height()-50&&loadMore()};$("#filterForm").submit(function(e){e.preventDefault(),document.activeElement.blur();var n={};$("#filterTitle").val().length>0&&(n.title=$("#filterTitle").val()),$("#filterNotes").val().length>0&&(n.notes=$("#filterNotes").val()),$("#filterRating").val()>-1&&(n.rating_id=$("#filterRating").val());var t=$("#filterStartDate").val(),o=Math.floor(new Date(t).getTime()/1e3),i=$("#filterEndDate").val(),a=Math.floor(new Date(i).getTime()/1e3);n.startdate=o,n.enddate=a,makeAuthRequest("/experience/search","POST",JSON.stringify(n),"json",function(e,n,t){$(".collection-item").remove(),$(window).off("scroll",autoLoader),$(".collapsible-header").click(),$(window).scrollTop(0),n?(n.sort(function(e,n){return parseFloat(n.date)-parseFloat(e.date)}),n.forEach(function(e){var n=JSON.stringify(e.consumptions).toLowerCase();if(-1!==n.indexOf($("#filterLocation").val().toLowerCase())&&-1!==n.indexOf($("#filterFriends").val().toLowerCase())&&-1!==n.indexOf($("#filterDrug").val().toLowerCase())&&-1!==n.indexOf($("#filterMethod").val().toLowerCase())){e.title.length<1&&(e.title="[none]");var t={};e.consumptions.forEach(function(e){t.hasOwnProperty(e.drug.name)?t[e.drug.name].count+=e.count:(t[e.drug.name]={},t[e.drug.name].count=e.count,t[e.drug.name].unit=e.drug.unit)});var o=[];if(Object.keys(t).length>0)for(var i in t)o.push(t[i].count+" "+t[i].unit+" "+i);else o.push("no consumptions");var a=[],r="Solo Experience";e.consumptions.forEach(function(e){e.friends.forEach(function(e){-1===a.indexOf(e.name)&&a.push(e.name)})}),a.length>0&&(r=a.join(", "));var l=[],c="[no location]";e.consumptions.forEach(function(e){-1===l.indexOf(e.location)&&l.push(e.location)}),l.length>0&&(c=l.join(", ")),$("#experiences-collection").append('<li class="collection-item">'+new Date(1e3*e.date).toISOString().slice(0,10)+'<span class="right hide-on-med-and-down" style="max-width: 50%;">'+r+" at <strong>"+c+'</strong></span><h5><a href="/experience.html?'+e.id+'">'+e.title+'</a></h5><div class="pad-left-40">'+o.join("<br />")+"</div></li>")}})):$("#experiences-collection").append('<li class="collection-item"><h5>No results</h5></li>')})}),loadMore(),prepareFilter(),$(window).scroll(autoLoader);